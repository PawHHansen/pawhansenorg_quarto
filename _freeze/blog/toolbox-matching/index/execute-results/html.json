{
  "hash": "31ea440e8e484afc90a620e46e793cdb",
  "result": {
    "markdown": "---\ntitle: \"The policy evaluator's toolbox: Matching\"\nauthor: \"Paw Hansen\"\ndate: '2023-01-14'\ncategories: [statistical analysis, policy evaluation]\nimage: featured.jpg\ndescription: 'Text about matching'\neditor_options: \n  chunk_output_type: console\ndraft: true\n---\n\n\n\n\nNew post for my [“policy evaluator’s toolbox” series](https://www.pawhansen.org/blog#category=policy%20evaluation)! Today, let's have a stab at an instrumental variable analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Packages used in this post\"}\nlibrary(tidyverse)\nlibrary(MatchIt)\nlibrary(broom)\nlibrary(ggsci)\nlibrary(janitor)\nlibrary(modelsummary)\nlibrary(estimatr)\n\ntheme_set(theme_minimal(base_size = 12))\n```\n:::\n\n\n### Using lalonde data\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"lalonde\")\n\nlalonde |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 614\nColumns: 9\n$ treat    <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n$ age      <int> 37, 22, 30, 27, 33, 22, 23, 32, 22, 33, 19, 21, 18, 27, 17, 1…\n$ educ     <int> 11, 9, 12, 11, 8, 9, 12, 11, 16, 12, 9, 13, 8, 10, 7, 10, 13,…\n$ race     <fct> black, hispan, black, black, black, black, black, black, blac…\n$ married  <int> 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…\n$ nodegree <int> 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1…\n$ re74     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ re75     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ re78     <dbl> 9930.0460, 3595.8940, 24909.4500, 7506.1460, 289.7899, 4056.4…\n```\n:::\n:::\n\n\n### Check initial imlbalance\n\n::: {.cell}\n\n```{.r .cell-code}\n# No matching; constructing a pre-match matchit object\nm_out_no_match <- matchit(treat ~ age + educ + race + married + \n                   nodegree + re74 + re75, data = lalonde,\n                 method = NULL, distance = \"glm\")\n\nout_temp <- summary(m_out_no_match)  \n\nout_temp \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nmatchit(formula = treat ~ age + educ + race + married + nodegree + \n    re74 + re75, data = lalonde, method = NULL, distance = \"glm\")\n\nSummary of Balance for All Data:\n           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\ndistance          0.5774        0.1822          1.7941     0.9211    0.3774\nage              25.8162       28.0303         -0.3094     0.4400    0.0813\neduc             10.3459       10.2354          0.0550     0.4959    0.0347\nraceblack         0.8432        0.2028          1.7615          .    0.6404\nracehispan        0.0595        0.1422         -0.3498          .    0.0827\nracewhite         0.0973        0.6550         -1.8819          .    0.5577\nmarried           0.1892        0.5128         -0.8263          .    0.3236\nnodegree          0.7081        0.5967          0.2450          .    0.1114\nre74           2095.5737     5619.2365         -0.7211     0.5181    0.2248\nre75           1532.0553     2466.4844         -0.2903     0.9563    0.1342\n           eCDF Max\ndistance     0.6444\nage          0.1577\neduc         0.1114\nraceblack    0.6404\nracehispan   0.0827\nracewhite    0.5577\nmarried      0.3236\nnodegree     0.1114\nre74         0.4470\nre75         0.2876\n\nSample Sizes:\n          Control Treated\nAll           429     185\nMatched       429     185\nUnmatched       0       0\nDiscarded       0       0\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nconvert_to_tbl <- function(x) {\n  out_tbl <-\n  as.data.frame(x[[\"sum.matched\"]]) |>  \n  rownames_to_column(var = \"variable\") |>  \n  as_tibble() |> \n  clean_names()\n  \n  return(out_tbl)\n}\n```\n:::\n\n\n\n### Matching\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1:1 NN PS matching w/o replacement\nm.out1 <- matchit(treat ~ age + educ + race + married + \n                   nodegree + re74 + re75, data = lalonde,\n                 method = \"nearest\", distance = \"glm\")\n```\n:::\n\n\n### Check balance in matched dataset\n\n::: {.cell}\n\n```{.r .cell-code}\n# Checking balance after nearest neighbour matching\nout <- summary(m.out1, un = FALSE)\n\nout_tbl <- \n  as.data.frame(out[[\"sum.matched\"]]) |>  \n  rownames_to_column(var = \"variable\") |>  \n  as_tibble() |> \n  clean_names()\n```\n:::\n\n\n244 units are unmacthed. \n\n### Make a Love plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nout_tbl |> \n  mutate(variable = fct_reorder(variable, std_pair_dist)) |> \n  ggplot(aes(std_pair_dist, variable)) + \n  geom_point() +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"steelblue\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nBalance not ideal... \n\n### Trying a Different Matching Specification\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Full matching on a probit PS\nm.out2 <- matchit(treat ~ age + educ + race + married + \n                   nodegree + re74 + re75, data = lalonde,\n                 method = \"full\", distance = \"glm\", link = \"probit\")\n\n# Checking balance after full matching\nsummary(m.out2, un = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nmatchit(formula = treat ~ age + educ + race + married + nodegree + \n    re74 + re75, data = lalonde, method = \"full\", distance = \"glm\", \n    link = \"probit\")\n\nSummary of Balance for Matched Data:\n           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\ndistance          0.5773        0.5764          0.0045     0.9949    0.0043\nage              25.8162       25.5347          0.0393     0.4790    0.0787\neduc             10.3459       10.5381         -0.0956     0.6192    0.0253\nraceblack         0.8432        0.8389          0.0119          .    0.0043\nracehispan        0.0595        0.0492          0.0435          .    0.0103\nracewhite         0.0973        0.1119         -0.0493          .    0.0146\nmarried           0.1892        0.1633          0.0660          .    0.0259\nnodegree          0.7081        0.6577          0.1110          .    0.0504\nre74           2095.5737     2100.2150         -0.0009     1.3467    0.0314\nre75           1532.0553     1561.4420         -0.0091     1.5906    0.0536\n           eCDF Max Std. Pair Dist.\ndistance     0.0486          0.0198\nage          0.2742          1.2843\neduc         0.0730          1.2179\nraceblack    0.0043          0.0162\nracehispan   0.0103          0.4412\nracewhite    0.0146          0.3454\nmarried      0.0259          0.4473\nnodegree     0.0504          0.9872\nre74         0.1881          0.8387\nre75         0.1984          0.8240\n\nSample Sizes:\n              Control Treated\nAll            429.       185\nMatched (ESS)   50.76     185\nMatched        429.       185\nUnmatched        0.         0\nDiscarded        0.         0\n```\n:::\n:::\n\n\nNew Love plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nout_full <- summary(m.out2, un = FALSE)\n\nout_full <- \n  as.data.frame(out_full[[\"sum.matched\"]]) |>  \n  rownames_to_column(var = \"variable\") |>  \n  as_tibble() |> \n  clean_names()\n\nout_full |> \n  mutate(variable = fct_reorder(variable, std_pair_dist)) |> \n  ggplot(aes(std_pair_dist, variable)) + \n  geom_point() +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"steelblue\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}